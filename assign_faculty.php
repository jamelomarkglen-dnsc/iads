<?php session_start(); require_once 'db.php'; require_once 'notifications_helper.php'; require_once 'concept_review_helpers.php'; if (!isset($_SESSION['user_id']) || ($_SESSION['role'] ?? '') !== 'program_chairperson') { header('Location: login.php'); exit; } ensureConceptReviewTables($conn); syncConceptPapersFromSubmissions($conn); $reviewerRoles = ['faculty']; $reviewerRoleLabels = [ 'faculty' => 'Faculty Reviewers', ]; $reviewerDashboardLinks = [ 'faculty' => 'subject_specialist_dashboard.php', ]; function formatDateToReadable(?string $date): string { if (!$date) { return 'Not specified'; } try { $dt = new DateTimeImmutable($date); return $dt->format('F d, Y g:i A'); } catch (Exception $e) { return $date; } } function reviewerStatusBadge(string $status): string { return match ($status) { 'completed' => 'bg-success-subtle text-success', 'in_progress' => 'bg-primary-subtle text-primary', 'declined' => 'bg-danger-subtle text-danger', default => 'bg-warning-subtle text-warning', }; } function tableColumnExists(mysqli $conn, string $table, string $column): bool { static $cache = []; $key = "{$table}.{$column}"; if (array_key_exists($key, $cache)) { return $cache[$key]; } $tableEscaped = $conn->real_escape_string($table); $columnEscaped = $conn->real_escape_string($column); $sql = " SELECT 1 FROM information_schema.COLUMNS WHERE TABLE_SCHEMA = DATABASE() AND TABLE_NAME = '{$tableEscaped}' AND COLUMN_NAME = '{$columnEscaped}' LIMIT 1 "; $result = $conn->query($sql); $exists = $result && $result->num_rows > 0; if ($result) { $result->free(); } $cache[$key] = $exists; return $exists; } function normalizeSubmissionTypeKey(?string $type): string { $value = strtolower(trim((string)$type)); if ($value === '') { return 'concept'; } if (strpos($value, 'dissertation') !== false) { return 'dissertation'; } if (strpos($value, 'thesis') !== false) { return 'thesis'; } if (strpos($value, 'capstone') !== false) { return 'capstone'; } if (strpos($value, 'concept') !== false || strpos($value, 'proposal') !== false) { return 'concept'; } return 'others'; } function classifySubmissionStatusBucket(?string $status): string { $value = strtolower(trim((string)$status)); if ($value === '') { return 'pending'; } $approvedTokens = ['approved', 'accepted', 'completed', 'cleared', 'confirmed', 'granted']; foreach ($approvedTokens as $token) { if ($token !== '' && strpos($value, $token) !== false) { return 'approved'; } } $inReviewTokens = ['review', 'checking', 'processing', 'evaluat', 'assigned']; foreach ($inReviewTokens as $token) { if ($token !== '' && strpos($value, $token) !== false) { return 'in_review'; } } return 'pending'; } function submissionStatusBadge(string $status): string { $bucket = classifySubmissionStatusBucket($status); return match ($bucket) { 'approved' => 'bg-success-subtle text-success', 'in_review' => 'bg-primary-subtle text-primary', default => 'bg-warning-subtle text-warning', }; } function sanitizeTextarea(string $input, int $maxLength = 800): string { $trimmed = trim(strip_tags($input)); if (function_exists('mb_strlen')) { if (mb_strlen($trimmed) > $maxLength) { $trimmed = mb_substr($trimmed, 0, $maxLength); } } else { if (strlen($trimmed) > $maxLength) { $trimmed = substr($trimmed, 0, $maxLength); } } return $trimmed; } function resolveReviewerRoleConflicts(array $roleAssignments, array $priority): array { $resolved = []; $seen = []; foreach ($priority as $role) { $resolved[$role] = []; foreach (($roleAssignments[$role] ?? []) as $id) { $id = (int)$id; if ($id <= 0 || isset($seen[$id])) { continue; } $seen[$id] = true; $resolved[$role][] = $id; } } foreach ($roleAssignments as $role => $ids) { if (array_key_exists($role, $resolved)) { continue; } $resolved[$role] = []; foreach ($ids as $id) { $id = (int)$id; if ($id <= 0 || isset($seen[$id])) { continue; } $seen[$id] = true; $resolved[$role][] = $id; } } return $resolved; } function fetchConceptGroups(mysqli $conn): array { $sql = " SELECT cp.id, cp.title, cp.assigned_faculty, cp.student_id, cp.created_at, u.firstname, u.lastname, u.email FROM concept_papers cp LEFT JOIN users u ON u.id = cp.student_id ORDER BY u.lastname ASC, cp.created_at ASC "; $result = $conn->query($sql); $groups = []; if ($result) { while ($row = $result->fetch_assoc()) { $studentId = (int)($row['student_id'] ?? 0); if (!$studentId) { $studentId = -1 * $row['id']; } if (!isset($groups[$studentId])) { $groups[$studentId] = [ 'student_id' => $studentId, 'student_name' => trim(($row['firstname'] ?? '') . ' ' . ($row['lastname'] ?? '')) ?: 'Unknown Student', 'student_email' => $row['email'] ?? 'Not provided', 'papers' => [], ]; } $groups[$studentId]['papers'][] = [ 'id' => (int)$row['id'], 'title' => $row['title'] ?? 'Untitled', 'assigned_faculty' => $row['assigned_faculty'] ?? '', 'created_at' => $row['created_at'] ?? null, ]; } $result->free(); } return $groups; } function fetchStudentInfo(mysqli $conn, int $studentId): ?array { if ($studentId <= 0) { return null; } $stmt = $conn->prepare("SELECT id, firstname, lastname, email FROM users WHERE id = ? LIMIT 1"); if (!$stmt) { return null; } $stmt->bind_param('i', $studentId); $stmt->execute(); $result = $stmt->get_result(); $row = $result ? $result->fetch_assoc() : null; $stmt->close(); return $row ?: null; } function papersBelongToStudent(mysqli $conn, int $studentId, array $paperIds): bool { if ($studentId <= 0 || empty($paperIds)) { return false; } $stmt = $conn->prepare("SELECT student_id FROM concept_papers WHERE id = ? LIMIT 1"); if (!$stmt) { return false; } foreach ($paperIds as $paperId) { $stmt->bind_param('i', $paperId); if (!$stmt->execute()) { $stmt->close(); return false; } $stmt->bind_result($ownerId); if (!$stmt->fetch() || (int)$ownerId !== $studentId) { $stmt->close(); return false; } $stmt->free_result(); } $stmt->close(); return true; } /** * Sync reviewer assignments per role and concept paper. * * @param array<int,int> $paperIds * @param array<string,array<int>> $roleAssignments * @return array<string,array<int>> Newly added reviewer IDs per role */ function syncReviewerAssignments(mysqli $conn, array $paperIds, int $studentId, array $roleAssignments, ?string $instructions, ?string $dueDate, int $assignerId): array { ensureConceptReviewTables($conn); $newAssignments = []; $selectStmt = $conn->prepare("SELECT reviewer_id FROM concept_reviewer_assignments WHERE concept_paper_id = ? AND reviewer_role = ?"); $deleteStmt = $conn->prepare("DELETE FROM concept_reviewer_assignments WHERE concept_paper_id = ? AND reviewer_role = ? AND reviewer_id = ?"); $insertStmt = $conn->prepare(" INSERT INTO concept_reviewer_assignments (concept_paper_id, student_id, reviewer_id, reviewer_role, assigned_by, instructions, due_at) VALUES (?, ?, ?, ?, ?, ?, ?) ON DUPLICATE KEY UPDATE instructions = VALUES(instructions), due_at = VALUES(due_at), assigned_by = VALUES(assigned_by), status = 'pending' "); foreach ($paperIds as $paperId) { foreach ($roleAssignments as $role => $reviewerIds) { $reviewerIds = array_values(array_unique(array_filter(array_map('intval', $reviewerIds)))); if ($selectStmt) { $existing = []; $selectStmt->bind_param('is', $paperId, $role); if ($selectStmt->execute()) { $result = $selectStmt->get_result(); if ($result) { while ($row = $result->fetch_assoc()) { $existing[] = (int)$row['reviewer_id']; } $result->free(); } } } else { $existing = []; } $toRemove = array_diff($existing, $reviewerIds); if ($deleteStmt) { foreach ($toRemove as $removeId) { $deleteStmt->bind_param('isi', $paperId, $role, $removeId); $deleteStmt->execute(); } } if ($insertStmt) { foreach ($reviewerIds as $reviewerId) { $insertStmt->bind_param( 'iiisiss', $paperId, $studentId, $reviewerId, $role, $assignerId, $instructions, $dueDate ); $insertStmt->execute(); if (!in_array($reviewerId, $existing, true)) { if (!isset($newAssignments[$role])) { $newAssignments[$role] = []; } $newAssignments[$role][] = $reviewerId; } } } } } if ($selectStmt) { $selectStmt->close(); } if ($deleteStmt) { $deleteStmt->close(); } if ($insertStmt) { $insertStmt->close(); } return $newAssignments; } $message = ''; $messageClass = ''; if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['assign_reviewers'])) { $facultySelections = array_values(array_filter([ (int)($_POST['faculty_id_1'] ?? 0), (int)($_POST['faculty_id_2'] ?? 0), (int)($_POST['faculty_id_3'] ?? 0), ])); if (!empty($facultySelections)) { $_POST['faculty_ids'] = array_values(array_unique($facultySelections)); } $studentId = (int)($_POST['student_id'] ?? 0); $paperIds = array_values(array_unique(array_map('intval', $_POST['paper_ids'] ?? []))); $roleAssignments = []; foreach ($reviewerRoles as $roleKey) { $field = "{$roleKey}_ids"; $roleAssignments[$roleKey] = array_values(array_unique(array_filter(array_map('intval', $_POST[$field] ?? [])))); } $dedupePriority = ['faculty']; $roleAssignments = resolveReviewerRoleConflicts($roleAssignments, $dedupePriority); $instructions = sanitizeTextarea($_POST['instructions'] ?? ''); $dueDateInput = trim((string)($_POST['due_at'] ?? '')); $dueDate = null; if ($dueDateInput !== '') { $dueDateObj = DateTime::createFromFormat('Y-m-d', $dueDateInput); if ($dueDateObj && $dueDateObj->format('Y-m-d') === $dueDateInput) { $dueDate = $dueDateInput; } else { $message = 'Please provide a valid due date (YYYY-MM-DD).'; $messageClass = 'danger'; } } $selectedCount = array_sum(array_map('count', $roleAssignments)); if (!$message && (!$studentId || empty($paperIds) || $selectedCount === 0)) { $message = 'Please select the student concept set and at least one faculty reviewer.'; $messageClass = 'danger'; } elseif (!$message && !papersBelongToStudent($conn, $studentId, $paperIds)) { $message = 'The submitted concept papers do not belong to the selected student.'; $messageClass = 'danger'; } if (!$message) { $facultyString = implode(',', $roleAssignments['faculty']); $updateStmt = $conn->prepare("UPDATE concept_papers SET assigned_faculty = ? WHERE id = ?"); if ($updateStmt) { foreach ($paperIds as $paperId) { $updateStmt->bind_param('si', $facultyString, $paperId); $updateStmt->execute(); } $updateStmt->close(); } $newAssignments = syncReviewerAssignments( $conn, $paperIds, $studentId, $roleAssignments, $instructions !== '' ? $instructions : null, $dueDate, (int)($_SESSION['user_id'] ?? 0) ); $summaryChunks = []; foreach ($roleAssignments as $role => $ids) { if (!empty($ids)) { $label = ucwords(str_replace('_', ' ', $role)); $summaryChunks[] = "{$label} (" . count($ids) . ")"; } } $message = 'Review assignment updated: ' . implode(', ', $summaryChunks); $messageClass = 'success'; $studentInfo = fetchStudentInfo($conn, $studentId); $studentName = trim(($studentInfo['firstname'] ?? '') . ' ' . ($studentInfo['lastname'] ?? '')) ?: 'the student'; $reviewersToNotify = []; foreach ($newAssignments as $role => $ids) { foreach ($ids as $id) { $reviewersToNotify[$id] = true; } } $reviewersToNotify = array_keys($reviewersToNotify); if (!empty($reviewersToNotify)) { foreach ($newAssignments as $roleKey => $ids) { if (empty($ids)) { continue; } $roleLabel = $reviewerRoleLabels[$roleKey] ?? ucwords(str_replace('_', ' ', $roleKey)); $body = "You have been assigned as {$roleLabel} to review the concept titles submitted by {$studentName}. Please rate each title and recommend which one to pursue."; if ($dueDate) { $body .= ' Kindly submit your evaluation by ' . date('F j, Y', strtotime($dueDate)) . '.'; } if ($instructions) { $body .= "\n\nInstructions from the Program Chairperson:\n" . $instructions; } $dashboardLink = $reviewerDashboardLinks[$roleKey] ?? 'subject_specialist_dashboard.php'; foreach ($ids as $rid) { notify_user( $conn, (int)$rid, 'Review assignment', $body, $dashboardLink, false ); } } } if ($studentId > 0) { $studentMessage = 'Reviewers were assigned to evaluate your concept papers.'; if ($dueDate) { $studentMessage .= ' Expect their recommendation on or before ' . date('F j, Y', strtotime($dueDate)) . '.'; } else { $studentMessage .= ' Expect feedback soon.'; } notify_user( $conn, $studentId, 'Reviewers assigned', $studentMessage, 'student_dashboard.php' ); } } } $directoryRoles = ['faculty']; $reviewerDirectory = fetchReviewerDirectory($conn, $directoryRoles); $facultyPool = $reviewerDirectory['by_role']['faculty'] ?? []; foreach ($reviewerRoles as $roleKey) { $reviewerDirectory['by_role'][$roleKey] = $facultyPool; } $reviewerShowcase = []; foreach ($reviewerRoles as $roleKey) { $roleRecords = array_values($reviewerDirectory['by_role'][$roleKey] ?? []); usort($roleRecords, function ($a, $b) { $nameA = trim(($a['lastname'] ?? '') . ' ' . ($a['firstname'] ?? '')); $nameB = trim(($b['lastname'] ?? '') . ' ' . ($b['firstname'] ?? '')); return strcasecmp($nameA, $nameB); }); $reviewerShowcase[$roleKey] = array_slice($roleRecords, 0, 6); } $conceptGroups = fetchConceptGroups($conn); $studentPaperMap = []; $assignmentIndex = fetchConceptAssignmentIndex($conn); $reviewerLookup = $reviewerDirectory['flat'] ?? []; $missingReviewerIds = []; foreach ($assignmentIndex as $paperData) { foreach (($paperData['all'] ?? []) as $assignment) { $rid = (int)($assignment['reviewer_id'] ?? 0); if ($rid > 0 && !isset($reviewerLookup[$rid])) { $missingReviewerIds[$rid] = true; } } } if (!empty($missingReviewerIds)) { $idList = implode(',', array_map('intval', array_keys($missingReviewerIds))); $reviewerResult = $conn->query("SELECT id, firstname, lastname FROM users WHERE id IN ({$idList})"); if ($reviewerResult) { while ($row = $reviewerResult->fetch_assoc()) { $rid = (int)($row['id'] ?? 0); if ($rid > 0) { $reviewerLookup[$rid] = $row; } } $reviewerResult->free(); } } foreach ($conceptGroups as &$group) { $group['needs_reviewers'] = false; $group['instructions'] = ''; $group['due_at'] = null; $searchParts = [$group['student_name'] ?? '', $group['student_email'] ?? '']; foreach ($group['papers'] as &$paper) { $paperId = (int)($paper['id'] ?? 0); $paperAssignments = $assignmentIndex[$paperId] ?? [ 'all' => [], 'by_role' => [], 'latest_instructions' => null, 'latest_due_at' => null, ]; $paper['review_assignments'] = $paperAssignments; $searchParts[] = $paper['title'] ?? ''; $hasAssignments = !empty($paperAssignments['all']); if (!$hasAssignments && trim((string)$paper['assigned_faculty']) === '') { $group['needs_reviewers'] = true; } if (!$group['instructions'] && !empty($paperAssignments['latest_instructions'])) { $group['instructions'] = $paperAssignments['latest_instructions']; } if (!$group['due_at'] && !empty($paperAssignments['latest_due_at'])) { $group['due_at'] = $paperAssignments['latest_due_at']; } } unset($paper); $group['search_index'] = strtolower(implode(' ', array_filter($searchParts))); $group['status_label'] = $group['needs_reviewers'] ? 'needs' : 'assigned'; $sid = (int)($group['student_id'] ?? 0); if ($sid) { $studentPaperMap[$sid] = array_map(fn($p) => (int)($p['id'] ?? 0), $group['papers']); } } unset($group); $studentsNeedingReviewers = array_filter($conceptGroups, fn($group) => !empty($group['needs_reviewers'])); $needsCount = count($studentsNeedingReviewers); $totalStudents = count($conceptGroups); $totalPapers = array_sum(array_map(fn($group) => count($group['papers']), $conceptGroups)); $assignedStudents = max(0, $totalStudents - $needsCount); $assignmentStats = getConceptAssignmentStats($conn); $reviewerPoolTotal = count($reviewerDirectory['flat']); $submissionsTableExists = tableColumnExists($conn, 'submissions', 'id'); $submissionsHasType = $submissionsTableExists && tableColumnExists($conn, 'submissions', 'type'); $submissionsHasStatus = $submissionsTableExists && tableColumnExists($conn, 'submissions', 'status'); $submissionsHasStudent = $submissionsTableExists && tableColumnExists($conn, 'submissions', 'student_id'); $submissionsHasCreatedAt = $submissionsTableExists && tableColumnExists($conn, 'submissions', 'created_at'); $pipelineStages = [ 'concept' => ['label' => 'Concept Papers', 'icon' => 'bi-layers-half', 'color' => 'success', 'total' => 0, 'pending' => 0, 'in_review' => 0, 'approved' => 0], 'thesis' => ['label' => 'Thesis Manuscripts', 'icon' => 'bi-journal-text', 'color' => 'primary', 'total' => 0, 'pending' => 0, 'in_review' => 0, 'approved' => 0], 'capstone' => ['label' => 'Capstone Projects', 'icon' => 'bi-layers', 'color' => 'info', 'total' => 0, 'pending' => 0, 'in_review' => 0, 'approved' => 0], 'dissertation' => ['label' => 'Dissertation Tracks', 'icon' => 'bi-mortarboard', 'color' => 'warning', 'total' => 0, 'pending' => 0, 'in_review' => 0, 'approved' => 0], 'others' => ['label' => 'Other Research', 'icon' => 'bi-columns-gap', 'color' => 'secondary', 'total' => 0, 'pending' => 0, 'in_review' => 0, 'approved' => 0], ]; $pipelineStageOrder = ['concept', 'thesis', 'capstone', 'dissertation', 'others']; if ($submissionsTableExists) { $typeExpr = $submissionsHasType ? "LOWER(COALESCE(type, 'concept paper'))" : "'concept paper'"; $statusExpr = $submissionsHasStatus ? "LOWER(COALESCE(status, 'pending'))" : "'pending'"; $pipelineSql = " SELECT {$typeExpr} AS type_key, {$statusExpr} AS status_key, COUNT(*) AS total FROM submissions GROUP BY type_key, status_key "; if ($pipelineResult = $conn->query($pipelineSql)) { while ($row = $pipelineResult->fetch_assoc()) { $stageKey = normalizeSubmissionTypeKey($row['type_key'] ?? ''); if (!isset($pipelineStages[$stageKey])) { $stageKey = 'others'; } $bucket = classifySubmissionStatusBucket($row['status_key'] ?? ''); $count = (int)($row['total'] ?? 0); $pipelineStages[$stageKey]['total'] += $count; $bucketKey = $bucket === 'approved' ? 'approved' : ($bucket === 'in_review' ? 'in_review' : 'pending'); $pipelineStages[$stageKey][$bucketKey] += $count; } $pipelineResult->free(); } } else { $inProgressAssignments = max(0, ($assignmentStats['total'] ?? 0) - ($assignmentStats['completed'] ?? 0)); $pipelineStages['concept']['total'] = $totalPapers; $pipelineStages['concept']['pending'] = $needsCount; $pipelineStages['concept']['in_review'] = $inProgressAssignments; $pipelineStages['concept']['approved'] = $assignmentStats['completed'] ?? 0; } $pipelineStageDisplay = []; foreach ($pipelineStageOrder as $stageKey) { if (!isset($pipelineStages[$stageKey])) { continue; } if ($stageKey === 'others' && ($pipelineStages[$stageKey]['total'] ?? 0) === 0) { continue; } $pipelineStageDisplay[$stageKey] = $pipelineStages[$stageKey]; } $pipelineTotalCount = array_reduce($pipelineStages, fn($carry, $stage) => $carry + ($stage['total'] ?? 0), 0); $latestSubmissionFeed = []; if ($submissionsTableExists) { $typeSelect = $submissionsHasType ? "COALESCE(s.type, 'Concept Paper')" : "'Concept Paper'"; $statusSelect = $submissionsHasStatus ? "COALESCE(s.status, 'Pending')" : "'Pending'"; $createdSelect = $submissionsHasCreatedAt ? 's.created_at' : 'NULL'; $studentNameSelect = $submissionsHasStudent ? "TRIM(CONCAT(COALESCE(u.firstname, ''), ' ', COALESCE(u.lastname, '')))" : "'Student'"; $studentIdSelect = $submissionsHasStudent ? 's.student_id' : 'NULL'; $studentJoin = $submissionsHasStudent ? 'LEFT JOIN users u ON u.id = s.student_id' : ''; $orderColumn = $submissionsHasCreatedAt ? 's.created_at' : 's.id'; $submissionSql = " SELECT s.id, s.title, {$typeSelect} AS submission_type, {$statusSelect} AS submission_status, {$createdSelect} AS submission_created_at, {$studentNameSelect} AS student_name, {$studentIdSelect} AS student_id FROM submissions s {$studentJoin} ORDER BY {$orderColumn} DESC LIMIT 6 "; if ($submissionResult = $conn->query($submissionSql)) { while ($row = $submissionResult->fetch_assoc()) { $latestSubmissionFeed[] = [ 'id' => (int)($row['id'] ?? 0), 'title' => $row['title'] ?? 'Untitled submission', 'type' => $row['submission_type'] ?? 'Concept Paper', 'status' => $row['submission_status'] ?? 'Pending', 'created_at' => $row['submission_created_at'] ?? null, 'student_name' => trim($row['student_name'] ?? 'Student'), 'student_id' => (int)($row['student_id'] ?? 0), ]; } $submissionResult->free(); } } $visibleConceptGroups = array_values($conceptGroups); $allStudents = []; $studentSql = "SELECT id, firstname, lastname, email FROM users WHERE role = 'student' ORDER BY lastname, firstname, id"; $studentResult = $conn->query($studentSql); if ($studentResult) { while ($row = $studentResult->fetch_assoc()) { $sid = (int)($row['id'] ?? 0); if (!$sid) { continue; } $allStudents[$sid] = [ 'id' => $sid, 'firstname' => $row['firstname'] ?? '', 'lastname' => $row['lastname'] ?? '', 'email' => $row['email'] ?? '', 'paper_ids' => $studentPaperMap[$sid] ?? [], ]; } $studentResult->free(); } $assignedSummaryIndex = []; $roleMap = [ 'faculty' => 'Faculty', ]; foreach ($assignmentIndex as $paperData) { foreach ($paperData['all'] as $assignment) { $sid = (int)($assignment['student_id'] ?? 0); $rid = (int)($assignment['reviewer_id'] ?? 0); $roleKey = $assignment['reviewer_role'] ?? ''; if (!$sid || !$rid || !isset($roleMap[$roleKey])) { continue; } $studentName = trim(($allStudents[$sid]['lastname'] ?? '') . ', ' . ($allStudents[$sid]['firstname'] ?? '')); if ($studentName === '' || $studentName === ',') { $studentName = 'Student #' . $sid; } $label = $roleMap[$roleKey]; if (!isset($assignedSummaryIndex[$sid])) { $assignedSummaryIndex[$sid] = [ 'student' => $studentName, 'roles' => [ 'Faculty' => [], ], ]; } $info = $reviewerLookup[$rid] ?? null; if ($info) { $name = trim(($info['firstname'] ?? '') . ' ' . ($info['lastname'] ?? '')); if ($name !== '' && !in_array($name, $assignedSummaryIndex[$sid]['roles'][$label], true)) { $assignedSummaryIndex[$sid]['roles'][$label][] = $name; } } } } $assignedSummary = array_values($assignedSummaryIndex); usort($assignedSummary, fn($a, $b) => strcasecmp($a['student'], $b['student'])); include 'header.php'; include 'sidebar.php'; ?> <!DOCTYPE html> <html lang="en"> <head> <meta charset="UTF-8"> <title>Assign Faculty Reviewers</title> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"> <style> body { background: #f6f8fb; } .content { margin-left: 220px; padding: 24px; min-height: 100vh; transition: margin-left .3s; } #sidebar.collapsed ~ .content { margin-left: 60px; } .hero-card { border-radius: 22px; background: linear-gradient(135deg, #16562c, #0f3d1f); color: #fff; padding: 28px; box-shadow: 0 22px 48px rgba(15, 61, 31, 0.25); } .pipeline-card { border-radius: 24px; box-shadow: 0 24px 60px rgba(15,61,31,.06); border: none; background: #fff; } .stage-item { border-radius: 18px; border: 1px solid rgba(22,86,44,.08); padding: 1rem; background: #fefefe; height: 100%; } .stage-pill { width: 46px; height: 46px; border-radius: 14px; background: rgba(22,86,44,.12); display: inline-flex; align-items: center; justify-content: center; font-size: 1.25rem; } .stage-progress { height: 6px; border-radius: 999px; background: rgba(12,53,22,.1); overflow: hidden; } .intake-card { border-radius: 22px; border: none; box-shadow: 0 20px 40px rgba(15,61,31,.08); } .intake-entry { padding: 0.85rem 0; border-bottom: 1px solid rgba(15,61,31,.08); display: flex; justify-content: space-between; gap: 1rem; flex-wrap: wrap; } .intake-entry:last-child { border-bottom: none; } .stat-card { border-radius: 18px; box-shadow: 0 18px 36px rgba(15,61,31,.08); border: none; } .student-card { border-radius: 22px; box-shadow: 0 18px 40px rgba(15,61,31,.12); border: none; overflow: hidden; } .student-card .list-group-item { border: none; border-bottom: 1px solid rgba(15,61,31,.08); } .keyword-badge { border-radius: 999px; background: rgba(15,61,31,.08); padding: .2rem .6rem; font-size: .85rem; margin-right: .25rem; } .assign-form select { min-height: 48px; } .assign-form textarea { resize: vertical; } .review-brief { border-radius: 16px; border: 1px dashed rgba(22,86,44,.25); background: #f4f8f2; padding: 0.85rem 1rem; } .review-brief .badge { margin-right: .5rem; } .status-pill { border-radius: 999px; padding: 0.2rem 0.75rem; font-size: 0.8rem; font-weight: 600; display: inline-flex; gap: 0.25rem; align-items: center; } .role-icon { width: 38px; height: 38px; border-radius: 12px; background: rgba(22,86,44,.12); display: inline-flex; align-items: center; justify-content: center; color: #16562c; } .role-description { font-size: 0.8rem; } .reviewer-pill { border-radius: 999px; padding: 0.35rem 0.85rem; font-size: 0.9rem; font-weight: 600; display: inline-flex; align-items: center; gap: 0.35rem; background: rgba(255,255,255,0.9); border: 1px solid rgba(22,86,44,0.15); } .reviewer-pill.completed { background: rgba(72,180,97,0.15); border-color: rgba(72,180,97,0.4); color: #0f6631; } .reviewer-pill.pending { background: rgba(255,193,7,0.15); border-color: rgba(255,193,7,0.4); color: #945400; } .reviewer-pool-card { border-radius: 18px; border: none; box-shadow: 0 18px 36px rgba(15,61,31,.08); height: 100%; } .reviewer-list { list-style: none; padding: 0; margin: 0; } .reviewer-list li { display: flex; justify-content: space-between; align-items: center; padding: 0.35rem 0; border-bottom: 1px solid rgba(15,61,31,.08); } .reviewer-list li:last-child { border-bottom: 0; } .reviewer-chip { background: rgba(22,86,44,.08); border-radius: 999px; padding: 0.15rem 0.65rem; font-size: 0.85rem; color: #16562c; } .assignment-layout { display: grid; grid-template-columns: minmax(280px, 0.85fr) minmax(420px, 1fr); gap: 1.5rem; align-items: stretch; } @media (max-width: 1199px) { .assignment-layout { grid-template-columns: 1fr; } } .concept-panel, .assign-panel { border-radius: 22px; border: 1px solid rgba(22,86,44,.12); background: #fff; padding: 1.25rem; box-shadow: 0 18px 36px rgba(15,61,31,.08); height: 100%; } .concept-panel { display: flex; flex-direction: column; gap: 1rem; } .concept-header { display: flex; flex-direction: column; gap: 0.35rem; } .concept-chip { display: inline-flex; align-items: center; justify-content: center; padding: 0.25rem 0.85rem; border-radius: 999px; font-size: 0.85rem; background: rgba(22,86,44,.08); color: #0f3d1f; letter-spacing: 0.05em; text-transform: uppercase; } .concept-stack { display: flex; flex-direction: column; gap: 0.75rem; } .role-summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; } .role-summary-card { border: 1px solid rgba(22,86,44,.12); border-radius: 16px; padding: 0.75rem; background: #f9faf8; } .role-summary-card p { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.4rem; color: #7c857d; } .concept-row { display: flex; justify-content: space-between; align-items: center; gap: 1rem; border: 1px solid rgba(22,86,44,.12); border-radius: 16px; padding: 0.85rem 1rem; background: #fefefe; } .concept-row h6 { margin: 0 0 0.25rem; font-size: 1rem; } .concept-meta { font-size: 0.8rem; color: #76827a; } .status-chip { border-radius: 12px; padding: 0.35rem 0.9rem; font-size: 0.85rem; text-transform: uppercase; } .assign-panel { display: flex; flex-direction: column; gap: 1.25rem; } .quick-assign-box { border: 1px dashed rgba(22,86,44,.25); border-radius: 18px; background: #f8fbf7; padding: 1rem 1.25rem; display: flex; flex-direction: column; gap: 1rem; } .quick-assign-intro { display: flex; justify-content: space-between; gap: 1rem; flex-wrap: wrap; } .quick-select-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; } .quick-reviewer-card { border: 1px solid rgba(22,86,44,.18); border-radius: 16px; padding: 0.75rem; background: #fff; text-align: center; box-shadow: 0 12px 24px rgba(15,61,31,.08); display: flex; flex-direction: column; gap: 0.5rem; } .quick-reviewer-card .form-label { font-weight: 700; margin-bottom: 0; } .quick-reviewer-card select { border-radius: 12px; text-align: center; font-weight: 600; } .reviewer-role-strip { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 0.85rem; } .reviewer-role-card { height: 100%; } .reviewer-role-group { border: 1px solid rgba(22,86,44,.18); border-radius: 16px; padding: 0.85rem 1rem; background: #fff; box-shadow: 0 12px 24px rgba(15,61,31,0.05); display: flex; flex-direction: column; gap: 0.5rem; } .reviewer-role-group .role-title { display: block; font-size: 0.95rem; font-weight: 700; text-transform: uppercase; color: #0f3d1f; } .reviewer-role-group select { border-radius: 14px; border: 1px solid rgba(22,86,44,0.2); } .reviewer-role-group select:focus { border-color: #16562c; box-shadow: 0 0 0 0.15rem rgba(22,86,44,.15); } .reviewer-role-group small { font-size: 0.75rem; } .instructions-box { border-radius: 18px; border: 1px solid rgba(22,86,44,.12); background: #fff; padding: 1rem; display: grid; grid-template-columns: 1fr 220px; gap: 1rem; } .concept-instructions-box { margin-top: 1rem; border: 1px solid rgba(22,86,44,.18); } @media (max-width: 767px) { .instructions-box { grid-template-columns: 1fr; } } @media (max-width: 992px) { .content { margin-left: 0; } } </style> </head> <body> <div class="content"> <div class="container-fluid"> <div class="hero-card mb-4"> <div class="d-flex flex-column flex-lg-row justify-content-between gap-3"> <div> <p class="text-uppercase small mb-1">Program Chairperson Workspace</p> <h2 class="fw-bold mb-2">Assign Faculty Reviewers</h2> <p class="mb-0">Coordinate concept papers, theses, capstones, and dissertations. Route each student's three concept titles to expert reviewers so they can mark Rank 1, 2, or 3 and endorse the final topic.</p> </div> <div class="text-end"> <span class="badge bg-light text-success fs-6"><?= number_format($totalPapers); ?> concept titles</span> <div class="small text-white-50 mt-1">Reviewer tasks in progress: <?= number_format($assignmentStats['pending'] ?? 0); ?></div> </div> </div> </div> <?php if (!empty($pipelineStageDisplay)): ?> <div class="card pipeline-card mb-4"> <div class="card-body"> <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center gap-3 mb-3"> <div> <p class="text-uppercase small text-muted mb-1">Research Lifecycle</p> <h3 class="fw-semibold mb-1">Monitor Intake to Evaluation</h3> <p class="text-muted mb-0"><?= number_format($pipelineTotalCount ?: $totalPapers); ?> total submissions across concept papers, theses, capstones, and dissertations.</p> </div> <a href="submissions.php" class="btn btn-outline-success"> <i class="bi bi-folder-check me-1"></i> Manage Submissions </a> </div> <div class="row g-3"> <?php foreach ($pipelineStageDisplay as $stageKey => $stageData): ?> <?php $stageTotal = max(0, (int)($stageData['total'] ?? 0)); $stagePending = max(0, (int)($stageData['pending'] ?? 0)); $stageReview = max(0, (int)($stageData['in_review'] ?? 0)); $stageApproved = max(0, (int)($stageData['approved'] ?? 0)); $completionPercent = $stageTotal > 0 ? round(($stageApproved / $stageTotal) * 100) : 0; $theme = $stageData['color'] ?? 'success'; $icon = $stageData['icon'] ?? 'bi-diagram-3'; ?> <div class="col-12 col-sm-6 col-xl-3"> <div class="stage-item h-100"> <div class="d-flex align-items-center justify-content-between mb-3"> <div class="stage-pill text-<?= htmlspecialchars($theme); ?>"> <i class="bi <?= htmlspecialchars($icon); ?>"></i> </div> <span class="badge bg-light text-<?= htmlspecialchars($theme); ?>"><?= number_format($stageTotal); ?> files</span> </div> <p class="fw-semibold mb-1 text-<?= htmlspecialchars($theme); ?>"><?= htmlspecialchars($stageData['label']); ?></p> <div class="progress stage-progress mb-2"> <div class="progress-bar bg-<?= htmlspecialchars($theme); ?>" role="progressbar" style="width: <?= $completionPercent; ?>%;" aria-valuenow="<?= $completionPercent; ?>" aria-valuemin="0" aria-valuemax="100"></div> </div> <div class="d-flex justify-content-between text-muted small"> <span><?= number_format($stagePending); ?> pending</span> <span><?= number_format($stageReview); ?> in-review</span> <span><?= number_format($stageApproved); ?> cleared</span> </div> </div> </div> <?php endforeach; ?> </div> </div> </div> <?php endif; ?> <?php if (!empty($conceptGroups)): ?> <div class="row g-4" id="studentCards"> <?php foreach ($visibleConceptGroups as $group): ?> <?php $needsReviewers = !empty($group['needs_reviewers']); $firstPaper = $group['papers'][0] ?? null; $roleSelections = []; foreach ($reviewerRoles as $roleKey) { $roleSelections[$roleKey] = []; if ($firstPaper && !empty($firstPaper['review_assignments']['by_role'][$roleKey])) { $roleSelections[$roleKey] = array_values(array_unique(array_map( fn($assignment) => (int)($assignment['reviewer_id'] ?? 0), $firstPaper['review_assignments']['by_role'][$roleKey] ))); } if ($roleKey === 'faculty' && empty($roleSelections[$roleKey]) && $firstPaper) { $legacy = array_filter(array_map('intval', explode(',', (string)($firstPaper['assigned_faculty'] ?? '')))); if (!empty($legacy)) { $roleSelections[$roleKey] = $legacy; } } } $facultySelections = array_values(array_unique($roleSelections['faculty'] ?? [])); $facultySelections = array_pad(array_slice($facultySelections, 0, 3), 3, 0); $dueAtValue = ''; if (!empty($group['due_at'])) { $dueTimestamp = strtotime($group['due_at']); if ($dueTimestamp) { $dueAtValue = date('Y-m-d', $dueTimestamp); } } ?> <div class="col-12 student-card-wrapper" data-student="<?= htmlspecialchars($group['search_index']); ?>" data-status="<?= htmlspecialchars($group['status_label']); ?>"> <div class="card student-card h-100"> <div class="card-body"> <div class="d-flex justify-content-between align-items-start mb-3"> <div> <h5 class="text-success mb-1"><?= htmlspecialchars($group['student_name']); ?></h5> <small class="text-muted"><?= htmlspecialchars($group['student_email']); ?></small> </div> <span class="badge <?= $needsReviewers ? 'bg-warning-subtle text-warning' : 'bg-success-subtle text-success'; ?>"> <?= $needsReviewers ? 'Needs reviewers' : 'Assigned'; ?> </span> </div> <form method="POST" class="assign-form"> <input type="hidden" name="assign_reviewers" value="1"> <input type="hidden" name="student_id" value="<?= (int)$group['student_id']; ?>"> <?php foreach ($group['papers'] as $paper): ?> <input type="hidden" name="paper_ids[]" value="<?= (int)$paper['id']; ?>"> <?php endforeach; ?> <div class="assignment-layout"> <div class="concept-panel"> <div class="concept-header"> <span class="concept-chip">Name of student</span> <h5 class="mb-0"><?= htmlspecialchars($group['student_name']); ?></h5> <small class="text-muted"><?= htmlspecialchars($group['student_email']); ?></small> </div> <div> <p class="fw-semibold mb-2">Concept titles</p> <div class="concept-stack"> <?php foreach ($group['papers'] as $paper): ?> <?php $isPending = empty($paper['review_assignments']['all']) && trim((string)$paper['assigned_faculty']) === ''; $statusClass = $isPending ? 'bg-secondary-subtle text-secondary' : 'bg-success-subtle text-success'; $statusLabel = $isPending ? 'Pending' : 'In review'; ?> <div class="concept-row"> <div> <h6><?= htmlspecialchars($paper['title']); ?></h6> <div class="concept-meta">Submitted <?= htmlspecialchars(formatDateToReadable($paper['created_at'] ?? '')); ?></div></div> <span class="status-chip <?= $statusClass; ?>"><?= $statusLabel; ?></span> </div> <?php endforeach; ?> </div> </div> <div class="instructions-box concept-instructions-box"> <div> <p class="text-uppercase small text-muted fw-semibold mb-1">Review instruction portion</p> <textarea class="form-control" name="instructions" rows="2" placeholder="Explain how reviewers should rate the student's titles"><?= htmlspecialchars($group['instructions']); ?></textarea> </div> <div> <p class="text-uppercase small text-muted fw-semibold mb-1">Date for calendar</p> <div class="input-group"> <span class="input-group-text bg-white"><i class="bi bi-calendar-event text-success"></i></span> <input type="date" class="form-control" name="due_at" value="<?= htmlspecialchars($dueAtValue); ?>"> </div> </div> </div> <?php $reviewerSummaryNames = []; $reviewerSummaryIndex = []; if ($firstPaper && !empty($firstPaper['review_assignments']['all'])) { foreach ($firstPaper['review_assignments']['all'] as $assignment) { $rid = (int)($assignment['reviewer_id'] ?? 0); if ($rid <= 0 || isset($reviewerSummaryIndex[$rid])) { continue; } $info = $reviewerLookup[$rid] ?? null; if ($info) { $name = trim(($info['firstname'] ?? '') . ' ' . ($info['lastname'] ?? '')); if ($name !== '') { $reviewerSummaryIndex[$rid] = true; $reviewerSummaryNames[] = $name; } } } } if (empty($reviewerSummaryNames) && $firstPaper) { $legacyIds = array_filter(array_map('intval', explode(',', (string)($firstPaper['assigned_faculty'] ?? '')))); foreach ($legacyIds as $rid) { if ($rid <= 0 || isset($reviewerSummaryIndex[$rid])) { continue; } $info = $reviewerLookup[$rid] ?? null; if ($info) { $name = trim(($info['firstname'] ?? '') . ' ' . ($info['lastname'] ?? '')); if ($name !== '') { $reviewerSummaryIndex[$rid] = true; $reviewerSummaryNames[] = $name; } } } } ?> <?php if (!empty($reviewerSummaryNames)): ?> <div class="role-summary-grid"> <div class="role-summary-card"> <p>Faculty reviewers</p> <?php foreach ($reviewerSummaryNames as $name): ?> <span class="keyword-badge"><?= htmlspecialchars($name); ?></span> <?php endforeach; ?> </div> </div> <?php endif; ?> </div> <div class="assign-panel"> <div class="reviewer-role-strip"> <?php foreach ($reviewerRoles as $roleKey): ?> <div class="reviewer-role-card"> <div class="reviewer-role-group"> <span class="role-title"><?= htmlspecialchars($reviewerRoleLabels[$roleKey] ?? 'Faculty Reviewers'); ?></span> <div class="row g-2"> <?php foreach ([1, 2, 3] as $slot): ?> <?php $selectedId = (int)($facultySelections[$slot - 1] ?? 0); ?> <div class="col-12 col-md-4"> <select class="form-select form-select-sm reviewer-select faculty-select" data-role="<?= htmlspecialchars($roleKey); ?>" data-slot="<?= $slot; ?>" name="faculty_id_<?= $slot; ?>"> <option value="" <?= $selectedId === 0 ? 'selected' : ''; ?>>Select Reviewer</option> <?php foreach (($reviewerDirectory['by_role'][$roleKey] ?? []) as $reviewerId => $reviewer): ?> <option value="<?= $reviewerId; ?>" <?= $reviewerId === $selectedId ? 'selected' : ''; ?>> <?= htmlspecialchars(trim(($reviewer['firstname'] ?? '') . ' ' . ($reviewer['lastname'] ?? ''))); ?> </option> <?php endforeach; ?> </select> </div> <?php endforeach; ?> </div> <small class="text-muted d-block mt-1">Choose up to three distinct faculty reviewers.</small> </div> </div> <?php endforeach; ?> </div> <div class="d-flex justify-content-between align-items-center"> <small class="text-muted">Reviewers will rate all titles and recommend one to pursue.</small> <button type="submit" class="btn btn-success">Save Assignment</button> </div> <?php $studentSummary = $assignedSummaryIndex[$group['student_id']] ?? null; ?> <div class="card assigned-summary-card"> <div class="card-body"> <p class="text-uppercase small text-muted fw-semibold mb-1">Assigned Evaluators</p> <h5 class="fw-semibold mb-3">Current faculty reviewers</h5> <div class="table-responsive"> <table class="table align-middle mb-0"> <thead class="table-light"> <tr> <th>Student</th> <th>Faculty Reviewers</th> </tr> </thead> <tbody> <?php if (empty($studentSummary)): ?> <tr> <td colspan="2" class="text-muted">No evaluators assigned yet. Assign faculty reviewers to see them listed here.</td> </tr> <?php else: ?> <tr> <td class="fw-semibold text-success"><?= htmlspecialchars($group['student_name']); ?></td> <?php foreach (['Faculty'] as $roleLabel): ?> <?php $names = $studentSummary['roles'][$roleLabel] ?? []; ?> <td> <?php if (empty($names)): ?> <span class="text-muted small">None</span> <?php else: ?> <?php foreach ($names as $name): ?> <span class="badge bg-light text-success border me-1 mb-1"><?= htmlspecialchars($name); ?></span> <?php endforeach; ?> <?php endif; ?> </td> <?php endforeach; ?> </tr> <?php endif; ?> </tbody> </table> </div> </div> </div> </div> </div> </form> </div> </div> </div> <?php endforeach; ?> </div> <?php endif; ?> </div> </div> <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script> <script> document.addEventListener('DOMContentLoaded', function () { const selects = Array.from(document.querySelectorAll('.faculty-select')); if (!selects.length) { return; } const updateOptions = () => { const selectedValues = selects .map((select) => select.value) .filter((value) => value !== ''); const selectedSet = new Set(selectedValues); selects.forEach((select) => { const currentValue = select.value; Array.from(select.options).forEach((option) => { if (!option.value) { option.hidden = false; return; } option.hidden = selectedSet.has(option.value) && option.value !== currentValue; }); }); }; selects.forEach((select) => { select.addEventListener('change', updateOptions); }); updateOptions(); }); </script> </body> </html>